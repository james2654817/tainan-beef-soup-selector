name: Auto Update Beef Soup Stores

on:
  # å®šæœŸåŸ·è¡Œï¼šæ¯å¤©å‡Œæ™¨ 2 é»žï¼ˆå°ç£æ™‚é–“ï¼‰
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 = å°ç£æ™‚é–“ 02:00
  
  # æ‰‹å‹•è§¸ç™¼
  workflow_dispatch:
  
  # æ¯é€±ä¸€æ¬¡ï¼ˆå¯é¸ï¼‰
  # schedule:
  #   - cron: '0 18 * * 0'  # æ¯é€±æ—¥ UTC 18:00

jobs:
  update-stores:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Run auto update script
        env:
          GOOGLE_PLACES_API_KEY: ${{ secrets.GOOGLE_PLACES_API_KEY }}
        run: |
          cd scripts
          python auto_update_stores.py
      
      - name: Commit and push if changed
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git add scripts/complete_stores_data.json
          git add scripts/update_report_*.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "ðŸ”„ Auto update stores data [$(date +'%Y-%m-%d %H:%M:%S')]" && git push)
      
      - name: Create update summary
        if: always()
        run: |
          echo "## ðŸœ åº—å®¶è³‡æ–™æ›´æ–°æ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # è®€å–æœ€æ–°çš„å ±å‘Šæª”æ¡ˆ
          LATEST_REPORT=$(ls -t scripts/update_report_*.json | head -1)
          
          if [ -f "$LATEST_REPORT" ]; then
            echo "### æ›´æ–°æ™‚é–“" >> $GITHUB_STEP_SUMMARY
            echo "$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### çµ±è¨ˆè³‡è¨Š" >> $GITHUB_STEP_SUMMARY
            python -c "
import json
with open('$LATEST_REPORT', 'r') as f:
    data = json.load(f)
    print(f\"- ç¸½åº—å®¶æ•¸ï¼š{data['total_stores']} é–“\")
    print(f\"- æ–°å¢žåº—å®¶ï¼š{data['new_stores']} é–“\")
    print(f\"- æ›´æ–°åº—å®¶ï¼š{data['updated_stores']} é–“\")
            " >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "âœ… æ›´æ–°æˆåŠŸï¼" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ æœªæ‰¾åˆ°æ›´æ–°å ±å‘Š" >> $GITHUB_STEP_SUMMARY
          fi

