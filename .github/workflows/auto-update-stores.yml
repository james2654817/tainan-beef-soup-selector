name: Auto Update Beef Soup Stores

on:
  # 定期執行：每天凌晨 2 點（台灣時間）
  schedule:
    - cron: '0 18 * * *'  # UTC 18:00 = 台灣時間 02:00
  
  # 手動觸發
  workflow_dispatch:
  
  # 每週一次（可選）
  # schedule:
  #   - cron: '0 18 * * 0'  # 每週日 UTC 18:00

jobs:
  update-stores:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests
      
      - name: Run auto update script
        env:
          GOOGLE_PLACES_API_KEY: ${{ secrets.GOOGLE_PLACES_API_KEY }}
        run: |
          cd scripts
          python auto_update_stores.py
      
      - name: Commit and push if changed
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git add scripts/complete_stores_data.json
          git add scripts/update_report_*.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "🔄 Auto update stores data [$(date +'%Y-%m-%d %H:%M:%S')]" && git push)
      
      - name: Create update summary
        if: always()
        run: |
          echo "## 🍜 店家資料更新摘要" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # 讀取最新的報告檔案
          LATEST_REPORT=$(ls -t scripts/update_report_*.json | head -1)
          
          if [ -f "$LATEST_REPORT" ]; then
            echo "### 更新時間" >> $GITHUB_STEP_SUMMARY
            echo "$(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            echo "### 統計資訊" >> $GITHUB_STEP_SUMMARY
            python -c "
import json
with open('$LATEST_REPORT', 'r') as f:
    data = json.load(f)
    print(f\"- 總店家數：{data['total_stores']} 間\")
    print(f\"- 新增店家：{data['new_stores']} 間\")
    print(f\"- 更新店家：{data['updated_stores']} 間\")
            " >> $GITHUB_STEP_SUMMARY
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "✅ 更新成功！" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ 未找到更新報告" >> $GITHUB_STEP_SUMMARY
          fi

