# 台南牛肉湯爬蟲 - 增強版使用指南

## 📋 三種搜尋策略說明

### 策略 1: 區域性文字搜尋
**原理**: 針對台南市每個行政區進行搜尋

**優點**:
- 覆蓋範圍廣，不會遺漏偏遠區域的店家
- 可以找到每個區域的特色店家

**搜尋關鍵字**:
- `台南中西區 牛肉湯`
- `台南中西區 溫體牛肉湯`
- `台南東區 牛肉湯`
- ... (共 37 個區域 × 2 個關鍵字 = 74 次搜尋)

**限制**: 每次搜尋最多返回 20 個結果

---

### 策略 2: Nearby Search API
**原理**: 在台南市中心點周圍搜尋店家

**優點**:
- 可以找到市中心密集區域的店家
- 結果更精準（只返回真正的牛肉湯店）

**搜尋參數**:
- 中心點: 台南火車站 (22.9971, 120.2133)
- 半徑: 15,000 公尺（15公里）
- 關鍵字: `牛肉湯`

**限制**: 每次搜尋最多返回 20 個結果

---

### 策略 3: 結合原始資料
**原理**: 保留原有店家並更新資訊

**優點**:
- 不會遺失原有的店家資料
- 自動更新評分、評論數、營業時間等
- 自動移除永久歇業的店家

**更新內容**:
- 評分和評論數
- 營業時間
- 營業狀態
- 照片

---

## 🚀 使用方法

### 1. 確認 API Key 已設定

```bash
# 檢查 .env 檔案
cat .env | grep GOOGLE_PLACES_API_KEY
```

應該看到：
```
GOOGLE_PLACES_API_KEY=AIzaSyD80kuCrJFFj2zsxRTrmxPTbRbVrqEAn3U
```

---

### 2. 執行增強版爬蟲

```bash
cd /home/ubuntu/tainan-beef-soup-selector
pnpm tsx scripts/crawl_google_maps_enhanced.ts
```

---

### 3. 執行過程

爬蟲會依序執行三個階段：

#### 階段 1: 區域性搜尋
```
📍 策略 1: 區域性搜尋
==================================================
🔍 搜尋: 台南中西區 牛肉湯
   找到 15 間店家
🔍 搜尋: 台南中西區 溫體牛肉湯
   找到 8 間店家
🔍 搜尋: 台南東區 牛肉湯
   找到 12 間店家
...
✅ 策略 1 完成，找到 120 間不重複店家
```

#### 階段 2: Nearby Search
```
📍 策略 2: Nearby Search（台南市中心）
==================================================
📍 搜尋附近店家: (22.9971, 120.2133), 半徑 15000m
   找到 20 間店家

✅ 策略 2 完成，總共 135 間不重複店家
```

#### 階段 3: 更新資料庫
```
📍 策略 3: 取得詳細資訊並更新資料庫
==================================================

處理: 阿益牛肉湯
   📍 區域: 東區
   ⭐ 評分: 4.4 (295則評論)
   ✅ 更新店家資訊

處理: 新發現牛肉湯
   📍 區域: 中西區
   ⭐ 評分: 4.5 (120則評論)
   ✅ 新增店家
   💬 新增 5 則評論
   📸 新增 10 張照片
...
```

---

### 4. 查看結果

```
==================================================
🎉 爬取完成！
==================================================
📊 總共找到: 135 間店家
✅ 新增店家: 25 間
🔄 更新店家: 95 間
❌ 歇業店家: 15 間

📈 資料庫總計: 220 間店家
```

---

## ⚙️ 進階設定

### 調整搜尋半徑

編輯 `crawl_google_maps_enhanced.ts`，修改第 115 行：

```typescript
const nearbyResults = await searchNearby(TAINAN_CENTER.lat, TAINAN_CENTER.lng, 15000);
//                                                                              ^^^^^ 改成其他數值（單位：公尺）
```

### 增加搜尋關鍵字

編輯第 79-82 行：

```typescript
const queries = [
  `台南${district} 牛肉湯`,
  `台南${district} 溫體牛肉湯`,
  `台南${district} 牛肉清湯`,  // 新增
];
```

### 調整 API 請求間隔

編輯第 105、122、290 行的 `setTimeout` 數值：

```typescript
await new Promise(resolve => setTimeout(resolve, 200));  // 200 毫秒
//                                                ^^^ 改成其他數值
```

**注意**: 間隔太短可能超過 API 限制，建議至少 200ms

---

## 📊 預期結果

使用三種策略後，預期可以找到：

| 策略 | 預期結果 |
|------|---------|
| 區域性搜尋 | 100-150 間店家 |
| Nearby Search | 新增 10-30 間店家 |
| 總計（去重後） | 120-180 間店家 |

加上原始資料中的店家（扣除歇業），最終資料庫應該有 **200-250 間店家**。

---

## ⏰ 定期執行

### 設定 cron job（每 2 天執行一次）

```bash
crontab -e
```

添加以下內容：

```bash
# 每 2 天凌晨 3 點執行增強版爬蟲
0 3 */2 * * cd /home/ubuntu/tainan-beef-soup-selector && GOOGLE_PLACES_API_KEY=AIzaSyD80kuCrJFFj2zsxRTrmxPTbRbVrqEAn3U pnpm tsx scripts/crawl_google_maps_enhanced.ts >> /tmp/crawler_enhanced.log 2>&1
```

---

## 🔍 故障排除

### 問題 1: API Key 無效

**錯誤訊息**: `REQUEST_DENIED` 或 `INVALID_REQUEST`

**解決方法**:
1. 確認 API Key 正確
2. 確認已啟用 Places API
3. 確認 API Key 沒有限制（或已允許當前 IP）

### 問題 2: 超過 API 限制

**錯誤訊息**: `OVER_QUERY_LIMIT`

**解決方法**:
1. 增加請求間隔（改為 500ms 或 1000ms）
2. 分批執行（先執行部分區域）
3. 檢查 Google Cloud Console 的配額

### 問題 3: 找不到店家

**可能原因**:
- 關鍵字不符（店家名稱不包含「牛肉湯」）
- 店家未在 Google Maps 上登記
- 區域判斷錯誤

**解決方法**:
- 增加更多搜尋關鍵字
- 手動補充遺漏的店家

---

## 📝 注意事項

1. **API 配額**: Google Places API 每天有免費配額限制，超過需付費
2. **執行時間**: 完整執行約需 10-15 分鐘（取決於店家數量）
3. **資料準確性**: 以 Google Maps 資料為準，可能與實際情況有差異
4. **重複執行**: 可以安全地重複執行，不會產生重複資料

---

## 🎯 最佳實踐

1. **首次執行**: 使用增強版爬蟲建立完整資料庫
2. **定期更新**: 每 2-3 天執行一次，保持資料最新
3. **手動補充**: 發現遺漏的店家可以手動添加
4. **備份資料**: 定期備份資料庫，避免資料遺失

---

## 📞 支援

如有問題，請檢查：
1. `/tmp/crawler_enhanced.log` - 執行日誌
2. Google Cloud Console - API 使用情況
3. 資料庫連線狀態

